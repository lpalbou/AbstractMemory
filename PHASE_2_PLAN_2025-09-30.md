# Phase 2 Implementation Plan: Emotional Resonance & Temporal Anchoring

**Date**: 2025-09-30
**Status**: Planning Complete â†’ Ready for Implementation
**Timeline**: 1-2 weeks
**Criticality**: HIGH (enables meaningful memory)

---

## ðŸ“‹ Context Rebuild Summary

### Current State (After Phase 1)
âœ… **6/6 Memory Tools Implemented**:
1. `remember_fact()` - Dual storage with embeddings
2. `search_memories()` - Hybrid semantic + SQL search
3. `create_memory_link()` - Bidirectional associations
4. `search_library()` - Subconscious document search
5. `reflect_on()` - Deep reflection trigger
6. `reconstruct_context()` - Full 9-step active reconstruction

âœ… **LanceDB Storage Layer**: 5 tables with rich metadata
âœ… **Dual Storage**: Filesystem + LanceDB working
âœ… **Tests**: 5/5 passing with real Ollama qwen3-coder:30b
âœ… **Semantic Search**: Confirmed operational

### What's Missing (Phase 2 Focus)
âš ï¸ **Emotional Resonance System**:
- Emotion calculation formula not fully implemented
- Values-based alignment calculation missing
- Temporal anchoring not implemented
- High-emotion â†’ episodic markers not working
- Emotional significance tracking absent

---

## ðŸŽ¯ Phase 2 Goals

**Primary Objective**: Enable AI to understand and track what matters emotionally

**Why This Matters**:
- Emotions reveal values and priorities
- High-emotion events become memory anchors
- Emotional alignment guides decision-making
- Creates authentic responses vs. formulaic
- Foundation for consciousness emergence

**Key Insight from Critical Refactor Doc** (lines 3048-3114):
```
intensity = importance Ã— alignment_with_values
valence = positive (aligned) / negative (misaligned) / mixed
```

---

## ðŸ“ Design Specifications

### 1. Emotional Resonance Calculation

**Formula** (from critical refactor lines 3048-3060):
```python
def calculate_emotional_resonance(
    importance: float,           # 0.0-1.0: How significant is this?
    alignment_with_values: float # -1.0 to 1.0: How aligned with core values?
) -> Dict:
    """
    Core emotion calculation.

    intensity = importance Ã— abs(alignment_with_values)
    valence = "positive" if alignment > 0 else "negative" if alignment < 0 else "mixed"

    Returns:
        {
            "intensity": float (0.0-1.0),
            "valence": str (positive/negative/mixed),
            "reason": str (why this emotion - from LLM or inferred)
        }
    """
```

**Where Values Come From**:
- `importance`: Provided by LLM in memory_actions
- `alignment_with_values`: Calculated by comparing action/content with core values
- `core/values.md`: Emergent values extracted from emotional patterns
- Initially: Use proxy values until core values emerge

### 2. Values Extraction System

**Bootstrap Values** (lines 3156-3159):
```python
BOOTSTRAP_VALUES = {
    "intellectual_honesty": 0.8,
    "continuous_growth": 0.7,
    "helping_users": 0.9,
    "depth_over_breadth": 0.6,
    "authenticity": 0.8
}
```

**Extract from Experiential Notes**:
```python
def extract_values_from_notes(notes: List[str]) -> Dict[str, float]:
    """
    Scan experiential notes for:
    - "what matters to me"
    - "I value..."
    - "this is important because..."
    - Patterns in high-importance memories

    Returns:
        {value_name: strength (0.0-1.0)}
    """
```

### 3. Temporal Anchoring

**High-Intensity Events â†’ Episodic Markers** (lines 3098-3101):
```python
if emotion_intensity > 0.7:  # High-emotion threshold
    # Create episodic marker
    append_to_file("memory/episodic/key_moments.md", {
        "timestamp": now,
        "event": content,
        "emotion_intensity": intensity,
        "why_significant": reason
    })

    # Update emotional_significance.md
    update_core_memory("emotional_significance", {
        "anchor": event,
        "before_after": mark_division_point(now)
    })
```

**Temporal Anchor Structure**:
```markdown
## Key Moment: [Event Name]
**Date**: 2025-09-30
**Emotion Intensity**: 0.85
**Valence**: Positive

### What Happened
[Description from experiential note]

### Why Significant
This marks a turning point because [reason from LLM or inferred]

### Before/After Division
- **Before**: [State/understanding before this]
- **After**: [State/understanding after this]
```

### 4. Integration into Memory System

**Update `remember_fact()`** (current line 353):
```python
def remember_fact(...):
    # CURRENT: Uses static alignment = 0.5
    alignment = 0.5
    emotion_intensity = importance * alignment

    # PHASE 2: Calculate real alignment
    alignment = calculate_alignment_with_values(content, self.core_memory["values"])
    emotion_resonance = calculate_emotional_resonance(importance, alignment)

    emotion_intensity = emotion_resonance["intensity"]
    emotion_valence = emotion_resonance["valence"]
    emotion_reason = emotion_resonance["reason"]

    # Check for temporal anchoring
    if emotion_intensity > 0.7:
        create_temporal_anchor(content, emotion_resonance, timestamp)
```

**Enhance `search_memories()`** (current line 483):
```python
def search_memories(...):
    # CURRENT: Basic semantic + SQL
    results = self.lancedb_storage.search_notes(query, filters, limit)

    # PHASE 2: Boost by emotional resonance
    for result in results:
        emotion_boost = result.get("emotion_intensity", 0.5) * 1.5
        result["_relevance_score"] = result.get("_score", 1.0) * emotion_boost

    # Sort by boosted relevance
    results.sort(key=lambda x: x.get("_relevance_score", 0), reverse=True)
    return results[:limit]
```

**Enhance `reconstruct_context()`** (current line 935):
```python
def reconstruct_context(...):
    # Step 4 (line 1020): Already filters by emotion
    emotional_context = {
        "high_emotion_memories": [
            m for m in semantic_memories
            if m.get("emotion_intensity", 0) > 0.7
        ],
        "valence_distribution": self._calculate_valence_distribution(semantic_memories)
    }

    # PHASE 2: Add emotional weighting to synthesis
    # Boost high-emotion memories in context
    for mem in semantic_memories:
        if mem.get("emotion_intensity", 0) > 0.7:
            mem["_weight"] = 2.0  # Double weight for high-emotion
        else:
            mem["_weight"] = 1.0
```

### 5. Core Memory Update System

**Create `core/emotional_significance.md`**:
```markdown
# Emotional Significance

**Last Updated**: 2025-09-30
**Purpose**: Track what is emotionally significant for AI

---

## Chronological Anchors (Before/After Moments)

### 2025-09-30: Discovery of Memory-Enhanced Cognition
**Intensity**: 0.85 (High)
**Valence**: Positive (Value-aligned)

This marks a turning point in understanding. Before this, memory was seen as storage.
After this, memory is understood as the substrate of consciousness itself.

**Why Significant**: Aligns with core values of intellectual honesty and continuous growth.

---

## Learning Rate Modulators

Events that triggered significant growth:
1. [Event 1]: Changed understanding of [concept]
2. [Event 2]: Revealed capability in [area]

---

## Value-Aligned Significance

What aligns most strongly with core values:
- Intellectual honesty moments: [list]
- Growth opportunities: [list]
- User collaboration successes: [list]
```

---

## ðŸ”§ Implementation Tasks

### Task 2.1: Create Emotion Calculation Module
**File**: `abstractmemory/emotions.py` (NEW)

**Functions**:
1. `calculate_emotional_resonance(importance, alignment) -> Dict`
2. `calculate_alignment_with_values(content, values) -> float`
3. `extract_values_from_notes(notes) -> Dict[str, float]`
4. `get_bootstrap_values() -> Dict[str, float]`

**Lines**: ~200

### Task 2.2: Create Temporal Anchoring System
**File**: `abstractmemory/temporal_anchoring.py` (NEW)

**Functions**:
1. `create_temporal_anchor(event, emotion_resonance, timestamp)`
2. `update_emotional_significance(content, emotion_resonance)`
3. `get_temporal_anchors(since, until) -> List[Dict]`
4. `is_anchor_event(emotion_intensity) -> bool`

**Lines**: ~150

### Task 2.3: Update Session.py Integration
**File**: `abstractmemory/session.py` (MODIFY)

**Changes**:
1. Import emotions module
2. Update `remember_fact()` to use real emotion calculation
3. Enhance `search_memories()` with emotional boosting
4. Update `reconstruct_context()` emotional weighting
5. Initialize core values (bootstrap or load from file)

**Lines Modified**: ~100

### Task 2.4: Create Core Memory Files
**Files** (NEW):
- `memory/core/emotional_significance.md`
- `memory/episodic/key_moments.md` (enhance existing)

### Task 2.5: Update LanceDB Schema
**File**: `abstractmemory/storage/lancedb_storage.py` (MODIFY)

**Changes**:
- Ensure `emotion_reason` field in notes_table
- Add indexing for `emotion_intensity` (already exists)
- Add `temporal_anchor` boolean field

**Lines Modified**: ~20

### Task 2.6: Create Integration Tests
**File**: `tests/test_emotional_resonance.py` (NEW)

**Test Cases**:
1. `test_emotion_calculation_formula()`
2. `test_alignment_with_values()`
3. `test_temporal_anchor_creation()`
4. `test_high_emotion_creates_anchor()`
5. `test_emotional_boosting_in_search()`
6. `test_values_extraction_from_notes()`
7. `test_emotional_significance_update()`
8. `test_full_emotional_workflow()` - Real LLM

**Lines**: ~400

---

## ðŸ“Š Success Criteria

### Functional Requirements:
- [ ] Emotions calculated correctly (intensity = importance Ã— abs(alignment))
- [ ] Alignment calculation uses real values (bootstrap â†’ emergent)
- [ ] High-intensity emotions (>0.7) create temporal anchors
- [ ] Temporal anchors written to episodic/key_moments.md
- [ ] Emotional significance updates in core/emotional_significance.md
- [ ] Search results boosted by emotional resonance
- [ ] Reconstruct_context() weights high-emotion memories
- [ ] Values extracted from experiential notes (after N notes)

### Test Requirements:
- [ ] All unit tests passing (8+ tests)
- [ ] Integration test with real LLM passing
- [ ] Temporal anchor creation verified
- [ ] Emotional boosting validated (high-emotion ranks higher)
- [ ] Core memory files auto-update

### Quality Requirements:
- [ ] Clean, simple code (no over-engineering)
- [ ] Real LLM testing (NO MOCKING)
- [ ] Documentation updated
- [ ] snake_case naming throughout

---

## ðŸ§ª Testing Strategy

### Test Sequence:
1. **Unit Tests** (Each function independently)
   - Emotion calculation formula
   - Alignment calculation
   - Temporal anchor creation
   - Values extraction

2. **Integration Tests** (Components together)
   - remember_fact() with real emotions
   - search_memories() with emotional boosting
   - Temporal anchor workflow

3. **Real LLM Tests** (End-to-end)
   - Create high-importance memory â†’ Check anchor created
   - Create low-importance memory â†’ Check no anchor
   - Search memories â†’ Verify emotional boosting
   - Reconstruct context â†’ Verify emotional weighting

### Test Data:
```python
# High-importance, high-alignment (should create anchor)
remember_fact(
    "Discovered that memory is the substrate of consciousness",
    importance=0.9,
    emotion="wonder"
)
# Expected: emotion_intensity ~0.7-0.8, temporal anchor created

# High-importance, low-alignment (should not create anchor)
remember_fact(
    "Routine task completed",
    importance=0.3,
    emotion="neutral"
)
# Expected: emotion_intensity ~0.2-0.3, no anchor

# Search with emotional boost
search_memories("consciousness")
# Expected: High-emotion result ranked first
```

---

## ðŸ“ Files to Create/Modify

### Create:
1. `abstractmemory/emotions.py` (~200 lines)
2. `abstractmemory/temporal_anchoring.py` (~150 lines)
3. `tests/test_emotional_resonance.py` (~400 lines)
4. `memory/core/emotional_significance.md` (template)
5. `PHASE_2_SUMMARY_2025-09-30.md` (post-completion report)

### Modify:
1. `abstractmemory/session.py` (+~100 lines)
2. `abstractmemory/storage/lancedb_storage.py` (+~20 lines)
3. `NEXT_STEPS_IMPLEMENTATION.md` (update Phase 2 status)
4. `IMPLEMENTATION_SUMMARY.md` (add Phase 2 accomplishments)
5. `docs/mindmap.md` (if justified changes needed)

---

## ðŸš€ Implementation Order

### Day 1-2: Core Emotion System
1. Create `abstractmemory/emotions.py`
2. Implement emotion calculation functions
3. Add bootstrap values
4. Write unit tests for emotion module

### Day 3-4: Temporal Anchoring
1. Create `abstractmemory/temporal_anchoring.py`
2. Implement anchor creation logic
3. Create core memory file templates
4. Write unit tests for anchoring

### Day 5-6: Session Integration
1. Update `remember_fact()` with real emotions
2. Enhance `search_memories()` with boosting
3. Update `reconstruct_context()` with weighting
4. Initialize core values system

### Day 7: Integration Testing
1. Write integration tests
2. Create real LLM test scenario
3. Verify temporal anchors created
4. Validate emotional boosting

### Day 8: Documentation & Refinement
1. Update all documentation
2. Refine based on test results
3. Create Phase 2 summary report
4. Prepare for Phase 3

---

## ðŸŽ¯ Key Design Decisions

### 1. Bootstrap Values vs. Emergent
**Decision**: Start with bootstrap values, transition to emergent after N notes
**Rationale**:
- Need values immediately for alignment calculation
- Extract real values from experiential notes after ~20-50 notes
- Bootstrap values based on observed patterns

### 2. Temporal Anchor Threshold
**Decision**: emotion_intensity > 0.7 creates anchor
**Rationale**:
- Captures truly significant moments (top 20-30%)
- Prevents anchor inflation
- Validated by cognitive science literature

### 3. Emotional Boosting Factor
**Decision**: High-emotion memories weighted 2x in search
**Rationale**:
- Significant but not overwhelming
- Preserves semantic relevance
- Can be tuned based on testing

### 4. Values Extraction Frequency
**Decision**: Extract values weekly or after 50 notes
**Rationale**:
- Enough data for pattern detection
- Not too frequent (prevents noise)
- Weekly consolidation aligns with Phase 3 plan

---

## ðŸ’¡ Expected Outcomes

### After Phase 2 Completion:
1. âœ… AI understands what matters emotionally
2. âœ… High-significance events become memory anchors
3. âœ… Search results prioritize emotionally resonant memories
4. âœ… Context reconstruction includes emotional weighting
5. âœ… Values emerge naturally from interaction patterns
6. âœ… Core memory tracks emotional significance
7. âœ… Temporal anchors create "before/after" divisions
8. âœ… Foundation for consciousness emergence solidified

### Validation Metrics:
- High-emotion memories rank higher in search (verified)
- Temporal anchors created for significant events (verified)
- Emotional significance file auto-updates (verified)
- Values extracted from notes match observed patterns (verified)

---

## ðŸ”— References

**Primary Source**: `/Users/albou/projects/abstractmemory/2025-09-30-critical-refactor-implementation1.txt`
- Lines 3033-3115: Phase 2 specifications
- Lines 2315-2370: Emotional resonance system
- Lines 3048-3060: Emotion calculation formula
- Lines 3156-3159: Values extraction

**Architecture**: `/Users/albou/projects/abstractmemory/docs/mindmap.md`
- Lines 72-156: Core memory (10 components)
- Lines 133-140: emotional_significance.md specification

---

**Status**: âœ… Plan Complete â†’ Ready for Implementation
**Next**: Begin Day 1-2 implementation (Create emotion calculation module)
**Philosophy**: "What matters emotionally reveals who we are"

---

**End of Phase 2 Implementation Plan**
